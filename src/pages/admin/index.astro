---
import Layout from '../../components/Layout.astro';
---

<Layout title="Admin Dashboard">
  <main class="admin-container">
    <h1>Document Publisher</h1>
    
    <div class="admin-card" id="auth-check">
      <p>Checking authentication...</p>
    </div>

    <div class="admin-content" id="admin-content" style="display: none;">
      <div class="admin-card">
        <h2>Welcome to the Document Publisher</h2>
        <p>Convert Notion documents to blog posts with AI assistance.</p>
        
        <div class="admin-actions">
          <a href="/admin/publish" class="btn btn-primary">Start Publishing</a>
          <a href="/api/auth/logout" class="btn btn-outline">Logout</a>
        </div>
      </div>
    </div>

    <div class="admin-card" id="login-required" style="display: none;">
      <h2>Authentication Required</h2>
      <p>Please log in to access the document publisher.</p>
      <a href="/admin/login" class="btn btn-primary">Go to Login</a>
    </div>

    <div class="error-message" id="error-message" style="display: none;"></div>
  </main>
</Layout>

<style>
  .admin-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }

  .admin-card {
    background: #f5f5f5;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid #e0e0e0;
  }

  .admin-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
    border: 2px solid;
    display: inline-block;
  }

  .btn-primary {
    background: #dc2626;
    color: white;
    border-color: #dc2626;
  }

  .btn-primary:hover {
    background: #b91c1c;
    border-color: #b91c1c;
  }

  .btn-outline {
    background: transparent;
    color: #333;
    border-color: #333;
  }

  .btn-outline:hover {
    background: #333;
    color: white;
  }

  .error-message {
    background: #fee2e2;
    color: #dc2626;
    padding: 1rem;
    border-radius: 4px;
    border: 1px solid #fecaca;
  }

  h1 {
    color: #dc2626;
    margin-bottom: 2rem;
  }

  h2 {
    color: #dc2626;
    margin-bottom: 1rem;
  }
</style>

<script>
  // Check authentication status
  async function checkAuth() {
    try {
      const response = await fetch('/api/notion?s=test');
      
      if (response.status === 401) {
        document.getElementById('auth-check').style.display = 'none';
        document.getElementById('login-required').style.display = 'block';
        return;
      }

      if (response.ok) {
        document.getElementById('auth-check').style.display = 'none';
        document.getElementById('admin-content').style.display = 'block';
        return;
      }

      throw new Error('Auth check failed');
    } catch (error) {
      document.getElementById('auth-check').style.display = 'none';
      document.getElementById('login-required').style.display = 'block';
    }
  }

  // Show error messages from URL params
  const urlParams = new URLSearchParams(window.location.search);
  const error = urlParams.get('error');
  
  if (error) {
    const errorMessage = document.getElementById('error-message');
    let message = 'An error occurred';
    
    switch (error) {
      case 'unauthorized':
        message = 'You are not authorized to access this application.';
        break;
      case 'no_code':
        message = 'Authentication failed: no authorization code received.';
        break;
      case 'auth_failed':
        message = 'Authentication failed. Please try again.';
        break;
    }
    
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
  }

  // Run auth check on page load
  checkAuth();
</script>